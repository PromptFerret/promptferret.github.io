name: Deploy MkDocs to GitHub Pages

on:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: write # needed so gh-deploy can push to gh-pages

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout (with private submodule)
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0
                  token: ${{ secrets.VAULT_PAT }} # fine-grained PAT scoped to the vault

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install MkDocs and dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install \
                    mkdocs-material \
                    mkdocs-roamlinks-plugin \
                    mkdocs-blog-plugin \
                    mkdocs-rss-plugin \
                    pymdown-extensions

            - name: Deploy to GitHub Pages (gh-pages branch)
              env:
                  GIT_AUTHOR_NAME: github-actions
                  GIT_AUTHOR_EMAIL: github-actions@github.com
                  GIT_COMMITTER_NAME: github-actions
                  GIT_COMMITTER_EMAIL: github-actions@github.com
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # used by gh-deploy to push
              run: |
                  mkdocs gh-deploy --clean --force --strict
