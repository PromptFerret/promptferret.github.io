name: Deploy MkDocs to GitHub Pages

on:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: write # needed so gh-deploy can push to gh-pages

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            # 1) Get repo + private submodule using your fine-grained PAT (read-only)
            - name: Checkout with PAT (includes submodules)
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.VAULT_PAT }} # scoped to promptferret_obsidian_vault (Contents: Read)
                  submodules: recursive
                  fetch-depth: 0
                  persist-credentials: false # don't keep PAT for later pushes

            # 2) Re-establish credentials with GITHUB_TOKEN for pushing gh-pages
            - name: Re-checkout to set GITHUB_TOKEN creds (no clean)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  submodules: false # submodule already fetched above
                  clean: false # keep working tree from step 1
                  persist-credentials: true # store GITHUB_TOKEN for push

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install MkDocs and dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install \
                    mkdocs-material \
                    mkdocs-roamlinks-plugin \
                    mkdocs-blog-plugin \
                    mkdocs-rss-plugin \
                    pymdown-extensions

            - name: Deploy to GitHub Pages (gh-pages branch)
              env:
                  GIT_AUTHOR_NAME: github-actions
                  GIT_AUTHOR_EMAIL: github-actions@github.com
                  GIT_COMMITTER_NAME: github-actions
                  GIT_COMMITTER_EMAIL: github-actions@github.com
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # lets gh-deploy push
              run: |
                  mkdocs gh-deploy --clean --force --strict
